<ion-header>
  <ion-toolbar style="height:auto;">
    <ion-buttons slot="start">
      <ion-back-button [defaultHref]="defaultHref"></ion-back-button>
    </ion-buttons>
    <ion-title *ngIf="transaction" class="ion-text-left text-capitalize">
      {{transaction.name|titlecase}}
    </ion-title>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true" class="ion-padding">
  <ng-container *ngIf="transaction">
    <ng-container *ngIf="detailsPageSegment.value === '01'">
      <div>
        <div class="border p-2 mt-2 w-100 pb-0">
          <p class="m-0 p-0 text-muted fw-bold">{{selectedDate|date:'MMMM-yyyy'}} Month Info :</p>
          <div class="d-flex justify-content-between w-100 py-1 px-2 border-bottom">
            <span class="text-truncate">Amount :</span><span>{{transaction.amount|currency:'INR'}}</span>
          </div>
          <div class="d-flex justify-content-between w-100 py-1 px-2 border-bottom">
            <span class="text-truncate">Instalment :</span><span>{{transaction.installment}}</span>
          </div>
          <div class="d-flex justify-content-between w-100 py-1 px-2 border-bottom">
            <span class="text-truncate">Due Date :</span><span>{{transaction?.dueDate|date:'dd-MMM-yyyy'}}</span>
          </div>
          <div class="d-flex justify-content-between align-items-center w-100 py-1 px-2 pt-1">
            <span class="text-truncate">Paid on :</span>
            <span>
              <span [class.bg-danger]="!transaction.isPaid" [class.bg-success]="transaction.isPaid" class="fs-6 badge rounded-pill fw-normal">
                  <ng-container *ngIf="transaction.isPaid">{{transaction.payment.paidOn|date:'dd-MMM-yyyy'}}</ng-container>
                  <ng-container *ngIf="!transaction.isPaid">Pending</ng-container>
              </span>
            </span>
          </div>
        </div>
        <div class="border p-2 mt-2 w-100">
          <p class="m-0 p-0 text-muted fw-bold">Over-all Info</p>
          <div class="d-flex flex-column justify-content-between w-100 py-1 px-2 pb-2 border-bottom">
            <div class="d-flex justify-content-between w-100 py-1 px-2 mt-1 border border-bottom-0">
              <span class="text-truncate">Installments :</span>
              <span>Repeat Every {{transaction.repeatInterval > 1 ? transaction.repeatInterval : ''}} {{transaction.repeatOption|titlecase}}</span>
            </div>
            <div class="d-flex flex-row w-100" style="font-size: 0.8rem;">
              <div
                class="col-4 py-1 d-flex justify-content-between align-items-center flex-column border border-end-0">
                <span class="text-truncate text-primary">Total <small>({{transaction.noOfInstallments}})</small></span>
                <span class="fw-bold text-primary">
                  {{(transaction.payments | pluck: 'amount').reduce(reduceAddCallBack)|currency:'INR'}}
                </span>
              </div>
              <div class="col-4 py-1 d-flex justify-content-between align-items-center flex-column border">
                <span class="text-truncate text-success">Paid <small>({{getNoOfPayment(transaction.payments, true)}})</small></span>
                <span class="fw-bold text-success">
                  {{((transaction.payments|filterBy:['isPaid']:true) | pluck: 'amount').reduce(reduceAddCallBack)|currency:'INR'}}
                </span>
              </div>
              <div class="col-4 py-1 d-flex justify-content-between align-items-center flex-column border border-start-0">
                <span class="text-truncate text-danger">Pending <small>({{getNoOfPayment(transaction.payments, false)}})</small></span>
                <span class="fw-bold text-danger">
                  {{((transaction.payments|filterBy:['isPaid']:false) | pluck: 'amount').reduce(reduceAddCallBack)|currency:'INR'}}
                </span>
              </div>
            </div>
          </div>


          <div class="d-flex justify-content-between w-100 py-1 px-2 mt-1 border-bottom">
            <span class="text-truncate">Start Date :</span>
            <span>{{transaction.dates.start}}</span>
          </div>
          <div class="d-flex justify-content-between w-100 py-1 px-2 border-bottom">
            <span class="text-truncate">End Date :</span>
            <span>{{transaction.dates.end}}</span>
          </div>
          <div class="d-flex justify-content-between w-100 py-1 px-2 border-bottom">

            <span class="text-truncate">Category :</span>
            <!--<span>{{getLabelByList(transaction.category, expensesCategories)}}</span>-->
          </div>
          <div class="d-flex justify-content-between w-100 py-1 px-2 border-bottom">
            <span class="text-truncate">Payee :</span>
            <!--<span>{{getLabelByList(transaction.payee, payees)}}</span>-->
          </div>
          <div class="d-flex justify-content-between w-100 py-1 px-2 border-bottom">
            <span class="text-truncate">Spending For :</span>
            <!--<span>{{getLabelByList(transaction.for, expensesFor)}}</span>-->
          </div>
          <div class="d-flex justify-content-between w-100 py-1 px-2 pb-0">
            <span class="text-truncate">Tax Savings :</span>
            <!--<span>{{getLabelByList(transaction.taxDeductionSection, taxDeductionSections)}}</span>-->
          </div>
        </div>
      </div>
    </ng-container>
    <ng-container *ngIf="detailsPageSegment.value === '02'">
      <mat-tab-group mat-stretch-tabs animationDuration="0ms" headerPosition="below" color="warn">
        <mat-tab label="All({{transaction.noOfInstallments}})">
          <ng-container *ngTemplateOutlet="breakUpsTemplateRef; context: {transaction:transaction,payments:transaction.payments}"></ng-container>
        </mat-tab>
        <mat-tab label="Paid({{getNoOfPayment(transaction.payments, true)}})">
          <ng-container *ngIf="transaction.payments|filterBy:['isPaid']:true as payments">
            <ng-container *ngTemplateOutlet="breakUpsTemplateRef; context: {transaction:transaction,payments:payments}"></ng-container>
          </ng-container>
        </mat-tab>
        <mat-tab label="Pending({{getNoOfPayment(transaction.payments, false)}})">
          <ng-container *ngIf="transaction.payments|filterBy:['isPaid']:false as payments">
            <ng-container *ngTemplateOutlet="breakUpsTemplateRef; context: {transaction:transaction,payments:payments}"></ng-container>
          </ng-container>
        </mat-tab>
      </mat-tab-group>

    </ng-container>
  </ng-container>
</ion-content>

<ion-footer>
  <ion-toolbar class="border-top" color="danger" style="--min-height: 40px;">
    <ion-segment #detailsPageSegment class="transaction-type-segment" value="01">
      <ion-segment-button value="01">
        <ion-label>Basic Detail</ion-label>
      </ion-segment-button>
      <ion-segment-button value="02">
        <ion-label>All Instalments</ion-label>
      </ion-segment-button>
    </ion-segment>
  </ion-toolbar>
</ion-footer>

<ng-template #breakUpsTemplateRef let-transaction="transaction" let-payments="payments">
  <ion-list style="overflow: hidden auto;max-height: calc(100vh - 180px);min-height: calc(100vh - 180px);height: calc(100vh - 180px);">
    <ion-item-sliding #transactionSliding *ngFor="let payment of payments" lines="full">
      <ion-item-options side="start">
        <ion-item-option (click)="markAsPaid(payment,transaction);transactionSliding.close();" *ngIf="!payment.isPaid" color="success" style="width: 100px;">
          <div class="d-flex flex-column justify-content-center align-items-center w-100 h-100">
            <span class="d-block text-white w-100 text-center" style="font-size: 10px;">Mark as</span>
            <ion-label class="fw-bold">Paid</ion-label>
          </div>
        </ion-item-option>
        <ion-item-option (click)="makeAsNotPaid(payment);transactionSliding.close();" *ngIf="payment.isPaid" color="danger" style="width: 100px;margin-right: 15px;">
          <div class="d-flex flex-column justify-content-center align-items-center w-100 h-100">
            <span class="d-block text-white w-100 text-center" style="font-size: 10px;">Mark as</span>
            <ion-label class="fw-bold">Not Paid</ion-label>
          </div>
        </ion-item-option>
      </ion-item-options>
      <ion-item lines="full">
        <ion-avatar slot="start">
          <div [class.border-danger]="!payment.isPaid" [class.border-success]="payment.isPaid" [class.text-danger]="!payment.isPaid" [class.text-success]="payment.isPaid" class="w-100 h-100 rounded-circle border d-flex justify-content-center align-items-center">
            {{payment.instalment}}
          </div>
        </ion-avatar>
        <ion-label>
          <h2 class="d-flex justify-content-between align-items-center">
            {{payment.dueDate|date:'dd-MMM-yyyy'}}
            <span [class.bg-danger]="!payment.isPaid" [class.bg-success]="payment.isPaid" class="badge rounded-pill fw-normal">
                <ng-container *ngIf="payment.isPaid">Paid: {{payment.paidOn|date:'dd-MMM-yyyy'}}</ng-container>
                <ng-container *ngIf="!payment.isPaid">Pending</ng-container>
              </span>
          </h2>
        </ion-label>
      </ion-item>
    </ion-item-sliding>
  </ion-list>
</ng-template>
